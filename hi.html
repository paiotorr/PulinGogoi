<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Team Video Submission · JoiZubeenDa</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta http-equiv="X-Frame-Options" content="DENY">

<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:Arial,Helvetica,sans-serif;background:#fafafa;color:#000;min-height:100vh}
header{background:#000;color:#fff;padding:16px;text-align:center;display:flex;align-items:center;justify-content:space-between;gap:12px}
header h1{font-size:20px;margin:0}
.header-actions{display:flex;gap:8px;align-items:center}
.header-actions button{background:transparent;border:1px solid rgba(255,255,255,0.18);color:#fff;padding:8px 10px;border-radius:8px;cursor:pointer}
.header-actions button:hover{opacity:0.92}
main{max-width:520px;margin:30px auto;padding:0 14px}
.card{background:#fff;border-radius:10px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
label{display:block;font-size:13px;font-weight:700;margin-bottom:6px}
input,select,button{
  width:100%;padding:11px 12px;margin-bottom:14px;
  border-radius:6px;border:1px solid #ccc;font-size:14px
}
button.primary{background:#000;color:#fff;border:none;font-weight:700;cursor:pointer}
.preview{display:none;margin-top:10px;border-top:1px solid #eee;padding-top:14px}
.preview img{width:100%;border-radius:6px}
.preview-title{font-size:14px;font-weight:700;margin-top:8px}
.status{font-size:13px;margin-top:10px;min-height:20px}
.status.ok{color:green}
.status.err{color:#c00}
footer{text-align:center;font-size:12px;color:#777;padding:18px 10px 24px}

/* Auth-check visuals */
#authCheck{max-width:520px;margin:60px auto;padding:20px;text-align:center;color:#444;font-size:14px}
</style>
</head>

<body>

  <!-- Visible until auth verified -->
  <div id="authCheck">Checking session — please wait…</div>

  <!-- App wrapper: hidden until user is authenticated as 'team' -->
  <div id="app" style="display:none">
    <header>
      <h1>Video Submission</h1>
      <div class="header-actions">
        <button id="btnLogout">Logout</button>
      </div>
    </header>

    <main>
      <div class="card">

        <label for="videoUrl">YouTube Video URL</label>
        <input id="videoUrl" type="url" placeholder="https://youtu.be/..." required>

        <label for="category">Select Category</label>
        <select id="category" aria-label="Select category"></select>

        <button id="addBtn" class="primary" disabled>Add Video</button>

        <div class="preview" id="preview">
          <img id="thumb" alt="Thumbnail">
          <div class="preview-title" id="videoTitle"></div>
        </div>

        <div class="status" id="status"></div>

      </div>
    </main>

    <footer>© 2026 JoiZubeenDa · Internal Team Tool</footer>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import {
    getFirestore, collection, doc, getDoc, addDoc, setDoc,
    onSnapshot, serverTimestamp, query, where, getDocs
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // ---------- Firebase config ----------
  const firebaseConfig = {
    apiKey: "AIzaSyC6cMfvfX68H-luCgPa32aXAc0D-x6bczU",
    authDomain: "zubeenda-17222.firebaseapp.com",
    projectId: "zubeenda-17222",
    storageBucket: "zubeenda-17222.firebasestorage.app",
    messagingSenderId: "541676751696",
    appId: "1:541676751696:web:e75867164d4372d3ad7a55"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ---------- DOM ----------
  const videoUrlEl = document.getElementById("videoUrl");
  const categoryEl = document.getElementById("category");
  const addBtn = document.getElementById("addBtn");
  const previewEl = document.getElementById("preview");
  const thumbEl = document.getElementById("thumb");
  const videoTitleEl = document.getElementById("videoTitle");
  const statusEl = document.getElementById("status");
  const btnLogout = document.getElementById("btnLogout");
  const appDiv = document.getElementById("app");
  const authCheck = document.getElementById("authCheck");

  // ---------- Helpers ----------
  function ytId(url){
    if(!url) return null;
    try {
      const u = new URL(url);
      const host = (u.hostname || '').replace('www.','').toLowerCase();
      if(host === 'youtu.be') {
        const id = u.pathname.slice(1);
        return id || null;
      }
      if(host.endsWith('youtube.com') || host === 'youtube.com' || host === 'm.youtube.com'){
        if(u.pathname === '/watch'){
          return u.searchParams.get('v') || null;
        }
        if(u.pathname.startsWith('/shorts/')){
          const parts = u.pathname.split('/');
          return parts[2] || null;
        }
        const embedMatch = u.pathname.match(/\/embed\/([A-Za-z0-9_-]+)/);
        if(embedMatch) return embedMatch[1];
        if(u.searchParams.get('v')) return u.searchParams.get('v');
      }
      return null;
    } catch(e){
      return null;
    }
  }

  function ytThumb(id){ return id ? `https://img.youtube.com/vi/${id}/hqdefault.jpg` : ''; }
  function nowReadable(){ return new Date().toLocaleString(); }
  function setStatus(text, ok){
    statusEl.textContent = text || "";
    statusEl.className = ok ? "status ok" : (text ? "status err" : "status");
  }

  async function fetchYouTubeTitle(originalUrl, idFallback){
    const oembedUrl = `https://www.youtube.com/oembed?url=${encodeURIComponent(originalUrl)}&format=json`;
    try {
      const res = await fetch(oembedUrl);
      if(!res.ok) throw new Error('oEmbed returned ' + res.status);
      const data = await res.json();
      if(data && data.title) return data.title;
      throw new Error('Invalid oEmbed response');
    } catch (err) {
      console.warn('YouTube oEmbed failed:', err);
      return `YouTube · ${idFallback || 'unknown'}`;
    }
  }

  // ---------- Auth & Role Guard (team only) ----------
  let currentUser = null;
  let categoriesUnsub = null;

  onAuthStateChanged(auth, async (user) => {
    // If not signed in, redirect to login immediately
    if(!user){
      sessionStorage.removeItem("jzd_session");
      // Give a tiny delay for the UX to show the auth-check message (optional).
      // Then redirect to login.
      location.replace("login.html");
      return;
    }

    // If we have a user, verify role in Firestore
    currentUser = user;
    try {
      const udoc = await getDoc(doc(db, "users", user.uid));
      if(!udoc.exists()){
        alert("No role assigned. Contact admin.");
        await signOut(auth);
        location.replace("login.html");
        return;
      }
      const u = udoc.data();
      if(u.role !== "team"){
        if(u.role === "admin"){
          location.replace("admin.html");
        } else {
          alert("Team access required.");
          await signOut(auth);
          location.replace("login.html");
        }
        return;
      }

      // role === "team" -> show the app and start listeners
      sessionStorage.setItem("jzd_session", JSON.stringify({
        uid: user.uid,
        email: user.email,
        role: u.role,
        name: u.name || ""
      }));

      // Show the app; hide the auth-check message
      authCheck.style.display = "none";
      appDiv.style.display = "block";

      // Enable the add button now that auth passed
      addBtn.disabled = false;

      // Start real-time category listener
      startCategoryListener();

    } catch (err) {
      console.error(err);
      alert("Auth verification failed. Re-login required.");
      await signOut(auth);
      location.replace("login.html");
    }
  });

  // ---------- Categories (real-time) ----------
  function startCategoryListener(){
    if(categoriesUnsub) categoriesUnsub();
    const col = collection(db, "categories");

    categoriesUnsub = onSnapshot(col, snap => {
      // Clear existing options
      categoryEl.innerHTML = "";

      // Add placeholder - ensures no real category is selected automatically.
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "Select a category";
      placeholder.disabled = true;
      placeholder.selected = true;
      categoryEl.appendChild(placeholder);

      const arr = [];
      snap.forEach(d => {
        const data = d.data();
        arr.push({ id: d.id, name: data.name || d.id });
      });

      if(arr.length === 0){
        // Fallback options (still keep placeholder selected)
        const fallback = ['song','live','interview'];
        fallback.forEach(c => {
          const opt = document.createElement("option");
          opt.value = c;
          opt.textContent = c;
          categoryEl.appendChild(opt);
        });
        return;
      }

      arr.sort((a,b)=> a.name.localeCompare(b.name));
      arr.forEach(item => {
        const opt = document.createElement("option");
        opt.value = item.id;
        opt.textContent = item.name;
        categoryEl.appendChild(opt);
      });
    }, err => {
      console.error("categories snapshot error", err);
    });
  }

  // ---------- Duplicate check helper (FIXED) ----------
  // Enforce uniqueness on (videoId + category) only.
  async function checkDuplicateVideo(videoId, categoryId) {
    const id = (videoId || "").trim();
    const cat = (categoryId || "").toString().trim();

    if(!id || !cat) return false; // can't check properly without both

    const videosCol = collection(db, "videos");

    try {
      // Query videos where videoId == id AND category == selected category
      const q = query(
        videosCol,
        where("videoId", "==", id),
        where("category", "==", cat)
      );

      const snap = await getDocs(q);
      return snap.size > 0; // true => duplicate inside same category
    } catch (err) {
      console.error("Duplicate check failed:", err);
      throw new Error("Could not verify duplicates (network/permission). Try again.");
    }
  }

  // ---------- Add video ----------
  addBtn.addEventListener("click", async () => {
    setStatus("", false);
    const url = (videoUrlEl.value || "").trim();
    const categoryId = categoryEl.value;
    const id = ytId(url);

    if(!id){
      setStatus("Invalid or unsupported YouTube URL. Supported: youtube.com/watch?v=, youtu.be/, youtube.com/shorts/", false);
      return;
    }
    if(!categoryId){
      setStatus("Please select a category", false);
      return;
    }

    addBtn.disabled = true;
    addBtn.textContent = "Checking...";

    try {
      const thumb = ytThumb(id);

      const title = await fetchYouTubeTitle(url, id);

      // NOTE: changed to check uniqueness within the selected category only
      const isDuplicate = await checkDuplicateVideo(id, categoryId);
      if(isDuplicate){
        setStatus("This video has already been added to the selected category.", false);
        addBtn.disabled = false;
        addBtn.textContent = "Add Video";
        return;
      }

      const videoDoc = {
        id,
        title,
        url,
        videoId: id,
        videoTitle: title,
        videoUrl: url,
        category: categoryId,
        thumb,
        addedBy: currentUser.email || "",
        createdAt: serverTimestamp(),
        time: nowReadable()
      };

      await addDoc(collection(db, "videos"), videoDoc);

      thumbEl.src = thumb;
      videoTitleEl.textContent = title;
      previewEl.style.display = "block";
      setStatus("Video added successfully ✔", true);

      videoUrlEl.value = "";

    } catch (err) {
      console.error(err);
      setStatus("Failed to add video: " + (err.message || err), false);
    } finally {
      addBtn.disabled = false;
      addBtn.textContent = "Add Video";
    }
  });

  // ---------- Logout ----------
  btnLogout.addEventListener('click', async () => {
    try { await signOut(auth); } catch(_) {}
    sessionStorage.removeItem("jzd_session");
    location.replace("login.html");
  });

  // ---------- Small client hardening (non-breaking) ----------
  document.addEventListener('contextmenu', e => e.preventDefault());
</script>

<script>
// Disable Right Click
document.addEventListener('contextmenu', function(e) {
    e.preventDefault();
});

// Disable Key Shortcuts
document.addEventListener('keydown', function(e) {

    // Block F12
    if (e.keyCode == 123) {
        e.preventDefault();
    }

    // Block Ctrl+Shift+I / Ctrl+Shift+J / Ctrl+U
    if (e.ctrlKey && e.shiftKey && (e.keyCode == 73 || e.keyCode == 74)) {
        e.preventDefault();
    }

    if (e.ctrlKey && e.keyCode == 85) {
        e.preventDefault();
    }

    // Block Ctrl+S, Ctrl+C,
    if (e.ctrlKey && (e.keyCode == 83 || e.keyCode == 67)) {
        e.preventDefault();
    }
});
</script>

</body>
</html>
