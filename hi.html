<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Joi Zubeen Da - PAIOTORR (player update)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta http-equiv="X-Content-Type-Options" content="nosniff" />
<meta http-equiv="X-Frame-Options" content="DENY" />
<meta name="referrer" content="no-referrer" />

<style>
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    font-family:Arial,Helvetica,sans-serif;
    background:#fff;color:#000;
    -webkit-touch-callout:none;-webkit-user-select:none;
    -khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;
    overflow-x:hidden;
  }

  .header{background:#000;color:#fff;text-align:center;padding:14px 12px 10px; position: relative;}
  .header-title{font-size:20px;font-weight:700;margin-bottom:8px}
  .login-btn{position:absolute;left:10px;top:10px;padding:6px 12px;border-radius:18px;border:1px solid #fff;background:transparent;color:#fff;font-size:12px;text-decoration:none;display:inline-block;line-height:1;cursor:pointer;transition:opacity .12s, transform .06s}
  .login-btn:active{transform:translateY(1px)}
  .login-btn[aria-disabled="true"]{opacity:.5;pointer-events:none}

  .cat-wrap{
    margin:12px auto 0;
    max-width:100%;
    width:100%;
    overflow:hidden;
    padding:10px 8px 20px;
    box-sizing:border-box;
  }

  .cat-scroll{
    display:flex;
    gap:14px;
    align-items:center;
    padding:6px 12px;
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
    scroll-behavior:smooth;
    scrollbar-width:none;
  }
  .cat-scroll::-webkit-scrollbar{ display:none; }

  .category-pill{
    flex: 0 0 auto;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:12px 26px;
    border-radius:40px;
    background:#000;
    color:#fff;
    font-weight:700;
    font-size:15px;
    white-space:nowrap;
    cursor:pointer;
    user-select:none;
    transition:transform .08s, background .12s, color .12s;
    border: 2px solid transparent;
  }
  .category-pill:active{ transform: translateY(1px); }
  .category-pill:focus{ outline: none; box-shadow: 0 0 0 3px rgba(0,0,0,0.08); }

  .category-pill.active{
    background:#fff;
    color:#000;
    border-color:#000;
  }

  .content{max-width:900px;margin:16px auto 30px;padding:0 10px}
  .search-wrapper{text-align:center;margin-bottom:16px}
  #searchInput{width:100%;max-width:400px;padding:10px 12px;border-radius:22px;border:1px solid #ccc;font-size:14px}
  .video-list{list-style:none}
  .video-item{display:flex;align-items:center;gap:10px;padding:10px 6px;border-bottom:1px solid #eee;cursor:pointer;transition:background .12s,transform .06s}
  .video-item:hover{background:#f7f7f7}
  .serial{font-size:13px;min-width:28px}
  .thumb-wrapper{flex-shrink:0;width:120px;height:68px;overflow:hidden;border-radius:6px;background:#ddd}
  .thumb-wrapper img{width:100%;height:100%;object-fit:cover;display:block;pointer-events:none;user-drag:none}
  .video-title{font-size:14px;line-height:1.2}
  .no-results{text-align:center;padding:24px 0;font-size:14px;color:#555;display:none}
  .site-footer{text-align:center;padding:16px 10px 22px;color:#777;font-size:13px}
  .end-note{text-align:center;padding:8px 0;color:#333}

  /* Player UI (bottom) */
  #playerContainer {
    position: fixed;
    left: 12px;
    right: 12px;
    bottom: 12px;
    max-width: 980px;
    margin: 0 auto;
    z-index: 9999;
    display: none; /* shown when playing */
    background: rgba(255,255,255,0.98);
    box-shadow: 0 10px 30px rgba(0,0,0,0.12);
    border-radius: 14px;
    overflow: hidden;
    align-items: center;
    gap: 12px;
    padding: 8px;
  }
  #playerFrameWrap { flex: 0 0 200px; height: 112px; background: #000; border-radius: 8px; overflow: hidden; }
  #playerFrame { width:100%; height:100%; border:0; display:block; }
  .player-controls { flex:1; display:flex; flex-direction:column; gap:6px; padding-right:8px; }
  .player-meta { font-size:13px; font-weight:700; color:#111; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
  .player-buttons { display:flex; gap:6px; align-items:center; }
  .player-buttons button { background:#000;color:#fff;border:none;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:700; }
  .player-close { background:transparent;color:#666;border:0;font-size:14px;cursor:pointer;padding:6px; }

  @media (max-width:720px) {
    #playerFrameWrap { flex: 0 0 140px; height: 80px; }
    #playerContainer { left:8px; right:8px; padding:6px; }
  }

</style>
</head>
<body>

  <header class="header" role="banner">
    <a class="login-btn" href="login.html" aria-label="Login">LOGIN</a>
    <div class="header-title">Joi Zubeen Da - Paiotorr</div>

    <div class="cat-wrap" id="catWrap" aria-hidden="false" style="position:relative;">
      <div id="catScroll" class="cat-scroll" role="tablist" aria-label="Categories"></div>
    </div>
  </header>

  <main class="content" role="main">
    <div class="search-wrapper">
      <input type="text" id="searchInput" placeholder="Search videos in this section…" aria-label="Search videos"/>
    </div>

    <ul id="videoList" class="video-list" aria-live="polite"></ul>
    <div id="noResults" class="no-results">No videos found for this search.</div>

    <div class="end-note"><strong>More Coming Soon.....</strong></div>
  </main>

  <footer class="site-footer" role="contentinfo">
    <div class="copyright">&copy; 2026 PAIOTORR</div>
  </footer>

  <!-- Embedded player container (added) -->
  <div id="playerContainer" aria-hidden="true" role="region" aria-label="Video player">
    <div id="playerFrameWrap"><div id="playerFrame"></div></div>
    <div class="player-controls">
      <div class="player-meta" id="playerTitle">Playing — </div>
      <div class="player-buttons">
        <button id="btnPrev" title="Previous">⏮ Prev</button>
        <button id="btnPlayPause" title="Play/Pause">▶️</button>
        <button id="btnNext" title="Next">Next ⏭</button>
        <button id="btnClose" class="player-close" title="Close player">✕</button>
      </div>
    </div>
  </div>

<script type="module">
  // Firebase imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // ---------- Firebase config ----------
  const firebaseConfig = {
    apiKey: "AIzaSyC6cMfvfX68H-luCgPa32aXAc0D-x6bczU",
    authDomain: "zubeenda-17222.firebaseapp.com",
    projectId: "zubeenda-17222",
    storageBucket: "zubeenda-17222.firebasestorage.app",
    messagingSenderId: "541676751696",
    appId: "1:541676751696:web:e75867164d4372d3ad7a55"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ---------- DOM ----------
  const catScroll = document.getElementById('catScroll');
  const searchInput = document.getElementById('searchInput');
  const videoListEl = document.getElementById('videoList');
  const noResultsEl = document.getElementById('noResults');

  const playerContainer = document.getElementById('playerContainer');
  const playerTitle = document.getElementById('playerTitle');
  const btnPrev = document.getElementById('btnPrev');
  const btnPlayPause = document.getElementById('btnPlayPause');
  const btnNext = document.getElementById('btnNext');
  const btnClose = document.getElementById('btnClose');

  // ---------- Defaults & fallback ----------
  const builtinVideos = [];

  // ---------- State ----------
  let categories = [];            // [{ id, name }]
  let currentCategory = null;     // category id (doc id or fallback string)
  let allVideos = [];             // array of normalized video objects (from Firestore + builtins)
  let categoriesUnsub = null;
  let videosUnsub = null;

  // Playlist / player state
  let activePlaylist = [];        // filtered for currentCategory
  let currentIndex = -1;          // index inside activePlaylist
  let ytPlayer = null;            // YT.Player instance
  let isPlaying = false;
  let playerReady = false;

  // ---------- Helpers ----------
  function titleCase(s){ return String(s).replace(/\b\w/g, c => c.toUpperCase()); }

  function getYouTubeId(url){
    try{
      const u = new URL(url);
      const host = (u.hostname || '').replace('www.','').toLowerCase();
      // youtu.be short link
      if(host === 'youtu.be') return u.pathname.slice(1);
      // youtube.com
      if(host.endsWith('youtube.com') || host === 'youtube.com' || host === 'm.youtube.com'){
        if(u.pathname === '/watch'){
          return u.searchParams.get('v') || '';
        }
        if(u.pathname.startsWith('/shorts/')){
          const parts = u.pathname.split('/');
          return parts[2] || '';
        }
        const embedMatch = u.pathname.match(/\/embed\/([A-Za-z0-9_-]+)/);
        if(embedMatch) return embedMatch[1] || '';
        return u.searchParams.get('v') || '';
      }
      return '';
    } catch(e){ return ''; }
  }

  function getThumbUrl(id){ return id ? 'https://img.youtube.com/vi/' + id + '/hqdefault.jpg' : ''; }
  function normalizeVideoItem(item){
    const id = item.id || getYouTubeId(item.url || '') || item.videoId || '';
    const url = item.url || (id ? `https://youtu.be/${id}` : '');
    return {
      id: id || '',
      category: (item.category || item.cat || 'song').toString(),
      title: item.title || item.name || (id ? `YouTube · ${id}` : 'Untitled'),
      url,
      thumb: item.thumb || (id ? getThumbUrl(id) : ''),
      addedBy: item.addedBy || item.user || 'team',
      time: item.time || item.addedOn || (item.createdAt && item.createdAt.toDate ? item.createdAt.toDate().toLocaleString() : '')
    };
  }

  // ---------- Render categories (pills) ----------
  function renderCategoryBar(){
    catScroll.innerHTML = '';
    const list = (categories && categories.length) ? categories : defaultCats.map(c => ({ id: c, name: c }));
    list.forEach(cat => {
      const pill = document.createElement('button');
      pill.className = 'category-pill' + ((currentCategory === cat.id) ? ' active' : '');
      pill.setAttribute('role','tab');
      pill.setAttribute('aria-selected', (currentCategory === cat.id) ? 'true' : 'false');
      pill.dataset.cat = cat.id;
      pill.tabIndex = 0;
      pill.innerText = titleCase(cat.name || cat.id);
      pill.addEventListener('click', () => {
        setActiveCategory(cat.id, true);
      });
      pill.addEventListener('keydown', e => {
        if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); setActiveCategory(cat.id, true); }
      });
      catScroll.appendChild(pill);
    });
  }
  function setActiveCategory(catId, shouldScrollIntoView){
    currentCategory = catId;
    Array.from(catScroll.children).forEach(btn => {
      if(btn.dataset.cat === catId){
        btn.classList.add('active');
        btn.setAttribute('aria-selected','true');
        if(shouldScrollIntoView){
          const rect = btn.getBoundingClientRect();
          const wrapRect = catScroll.getBoundingClientRect();
          const offset = rect.left - wrapRect.left - (wrapRect.width/2) + (rect.width/2);
          catScroll.scrollBy({ left: offset, behavior: 'smooth' });
        }
      } else {
        btn.classList.remove('active');
        btn.setAttribute('aria-selected','false');
      }
    });
    // rebuild active playlist after category change
    buildActivePlaylist();
    renderList();
  }

  // Build the playlist restricted to currentCategory
  function buildActivePlaylist(){
    if(!currentCategory){
      activePlaylist = allVideos.slice();
    } else {
      activePlaylist = allVideos.filter(v => String(v.category).toLowerCase() === String(currentCategory).toLowerCase());
    }
    // reset index if out of bounds
    if(currentIndex >= activePlaylist.length) currentIndex = -1;
  }

  // ---------- Render videos list ----------
  function renderList(){
    const q = (searchInput.value || '').trim().toLowerCase();
    const filtered = activePlaylist.filter(v => (v.title || '').toLowerCase().includes(q));

    videoListEl.innerHTML = '';
    noResultsEl.style.display = filtered.length ? 'none' : 'block';

    filtered.forEach((video, i) => {
      const id = video.id || getYouTubeId(video.url || '');
      const li = document.createElement('li');
      li.className='video-item'; li.setAttribute('role','link'); li.tabIndex=0;
      // Activation now plays inside the in-page player
      const activate = ()=> playVideoFromList(i);
      li.addEventListener('click',activate);
      li.addEventListener('keydown',e=>{ if(e.key==='Enter' || e.key===' ') activate(); });

      const serial = document.createElement('div'); serial.className='serial'; serial.textContent=(i+1)+')';
      const thumbWrap = document.createElement('div'); thumbWrap.className='thumb-wrapper';
      const img = document.createElement('img'); img.alt = video.title || 'Video';
      img.src = video.thumb || getThumbUrl(id);
      thumbWrap.appendChild(img);

      const titleDiv = document.createElement('div'); titleDiv.className='video-title'; titleDiv.textContent = video.title || 'Untitled Video';

      li.appendChild(serial); li.appendChild(thumbWrap); li.appendChild(titleDiv);
      videoListEl.appendChild(li);
    });
  }

  // Play a video from the currently-rendered list (filtered view)
  function playVideoFromList(filteredIndex){
    // filteredIndex corresponds to index inside current filtered render.
    // We must map this to index inside activePlaylist.
    const q = (searchInput.value || '').trim().toLowerCase();
    // create temporary filtered array and find element
    const filtered = activePlaylist.filter(v => (v.title || '').toLowerCase().includes(q));
    const target = filtered[filteredIndex];
    if(!target) return;
    // find the index inside activePlaylist
    const idx = activePlaylist.findIndex(v => v.url === target.url || v.id === target.id);
    if(idx === -1) return;
    playVideoAtIndex(idx);
  }

  // ---------- YouTube Player integration ----------
  // Load Iframe API (global)
  function loadYouTubeIframeAPI(){
    if(window.YT && window.YT.Player) { initPlayer(); return; }
    const tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.head.appendChild(tag);
    window.onYouTubeIframeAPIReady = () => { initPlayer(); };
  }

  function initPlayer(){
    // Create a hidden div target #playerFrame
    ytPlayer = new YT.Player('playerFrame', {
      height: '100%',
      width: '100%',
      videoId: '', // start empty
      playerVars: {
        autoplay: 0,
        controls: 1,
        rel: 0,
        modestbranding: 1,
        iv_load_policy: 3,
        playsinline: 1,
        fs: 0,
        disablekb: 1,
        // Note: autoplay with sound may be blocked by browsers; we attempt play on user gesture only.
      },
      events: {
        onReady: (e) => { playerReady = true; /* don't auto-play until user clicks */ },
        onStateChange: onPlayerStateChange,
        onError: (e) => console.warn('YT player error', e)
      }
    });
  }

  function onPlayerStateChange(event){
    const state = event.data;
    // YT.PlayerState.ENDED === 0
    if(typeof YT === 'undefined') return;
    if(state === YT.PlayerState.ENDED){
      // Auto play next video in activePlaylist
      playNext();
    } else if(state === YT.PlayerState.PLAYING){
      isPlaying = true;
      updatePlayerUI();
    } else if(state === YT.PlayerState.PAUSED){
      isPlaying = false;
      updatePlayerUI();
    }
  }

  function playVideoAtIndex(idx){
    if(!Array.isArray(activePlaylist) || idx < 0 || idx >= activePlaylist.length) return;
    currentIndex = idx;
    const video = activePlaylist[idx];
    if(!video || !video.id) return;
    // ensure player is initialized
    if(!ytPlayer) {
      loadYouTubeIframeAPI();
      // Wait for API ready; attempt again shortly if not ready
      const wait = setInterval(() => {
        if(playerReady && ytPlayer) {
          clearInterval(wait);
          loadAndPlay(video.id);
        }
      }, 200);
    } else if(!playerReady){
      // Wait
      const wait = setInterval(() => {
        if(playerReady) {
          clearInterval(wait);
          loadAndPlay(video.id);
        }
      },200);
    } else {
      loadAndPlay(video.id);
    }

    // show UI
    playerContainer.style.display = 'flex';
    playerContainer.setAttribute('aria-hidden', 'false');
    updatePlayerUI();
  }

  function loadAndPlay(ytId){
    try {
      // Using loadVideoById ensures replacing the same iframe; helps continuity & background audio
      ytPlayer.loadVideoById({ videoId: ytId, startSeconds: 0 });
      // Attempt to play (user gesture required in some browsers)
      try { ytPlayer.playVideo(); } catch(e){}
    } catch (err){
      console.error('Failed to load video', err);
    }
    updatePlayerUI();
  }

  function playNext(){
    if(currentIndex + 1 < activePlaylist.length){
      playVideoAtIndex(currentIndex + 1);
    } else {
      // end of playlist — stop and leave last video
      isPlaying = false;
      updatePlayerUI();
    }
  }

  function playPrev(){
    if(currentIndex - 1 >= 0){
      playVideoAtIndex(currentIndex - 1);
    } else {
      // at first item — restart
      playVideoAtIndex(0);
    }
  }

  function togglePlayPause(){
    if(!ytPlayer || !playerReady) return;
    try {
      const state = ytPlayer.getPlayerState();
      if(state === YT.PlayerState.PLAYING){
        ytPlayer.pauseVideo();
      } else {
        ytPlayer.playVideo();
      }
    } catch(e){}
  }

  function updatePlayerUI(){
    // update title and play/pause text
    if(currentIndex >= 0 && activePlaylist[currentIndex]){
      playerTitle.textContent = (activePlaylist[currentIndex].title || 'Untitled');
    } else {
      playerTitle.textContent = '—';
    }
    btnPlayPause.textContent = isPlaying ? '⏸ Pause' : '▶️ Play';
  }

  function closePlayer(){
    // stop playback but keep player in place so background behavior persists if supported
    try { if(ytPlayer && playerReady) ytPlayer.stopVideo(); } catch(e){}
    playerContainer.style.display = 'none';
    playerContainer.setAttribute('aria-hidden', 'true');
    isPlaying = false;
    currentIndex = -1;
    updatePlayerUI();
  }

  // Wire player buttons
  btnPrev.addEventListener('click', () => { playPrev(); });
  btnNext.addEventListener('click', () => { playNext(); });
  btnPlayPause.addEventListener('click', () => { togglePlayPause(); });
  btnClose.addEventListener('click', () => { closePlayer(); });

  // ---------- Auto-scroll for category bar ----------
  let autoScrollEnabled = true;
  let autoScrollStep = 0.4; // px per ms
  let lastFrame = null;
  let userInteracting = false;
  let resumeTimeout = null;

  function autoScrollFrame(ts){
    if(!lastFrame) lastFrame = ts;
    const dt = ts - lastFrame;
    lastFrame = ts;
    if(autoScrollEnabled && !userInteracting){
      catScroll.scrollLeft += autoScrollStep * dt;
      if(catScroll.scrollLeft + catScroll.clientWidth >= catScroll.scrollWidth - 1){
        catScroll.scrollTo({ left: 0 });
      }
    }
    window.requestAnimationFrame(autoScrollFrame);
  }

  function pauseAutoScroll(){
    userInteracting = true;
    if(resumeTimeout) clearTimeout(resumeTimeout);
    resumeTimeout = setTimeout(()=>{ userInteracting = false; }, 1800);
  }

  catScroll.addEventListener('pointerdown', e => { pauseAutoScroll(); });
  catScroll.addEventListener('touchstart', e => { pauseAutoScroll(); }, {passive:true});
  catScroll.addEventListener('wheel', e => { pauseAutoScroll(); }, {passive:true});
  catScroll.addEventListener('scroll', () => { pauseAutoScroll(); });

  // ---------- Firestore listeners ----------
  function startCategoryListener(){
    if(categoriesUnsub) categoriesUnsub();
    const col = collection(db, "categories");
    categoriesUnsub = onSnapshot(col, snap => {
      const out = [];
      snap.forEach(d => {
        const data = d.data();
        out.push({ id: d.id, name: data.name || d.id });
      });
      // sort by name
      out.sort((a,b)=> (a.name || '').localeCompare(b.name || ''));
      categories = out;
      if(!currentCategory && categories.length) currentCategory = categories[0].id;
      if(currentCategory && !categories.find(c=>c.id===currentCategory)){
        currentCategory = (categories[0] && categories[0].id) || defaultCats[0];
      }
      renderCategoryBar();
      renderList();
    }, err => {
      console.error("categories snapshot error", err);
      if(!categories || categories.length === 0){
        categories = defaultCats.map(c => ({ id: c, name: c }));
        if(!currentCategory) currentCategory = categories[0].id;
        renderCategoryBar();
      }
    });
  }

  function startVideoListener(){
    if(videosUnsub) videosUnsub();
    const col = collection(db, "videos");
    const q = query(col, orderBy("createdAt", "desc"));
    videosUnsub = onSnapshot(q, snap => {
      const rows = [];
      snap.forEach(d => {
        const data = d.data();
        rows.push({ ...data, docId: d.id });
      });
      const normalized = rows.map(normalizeVideoItem);
      const builtInNormalized = builtinVideos.map(normalizeVideoItem);
      allVideos = [...normalized, ...builtInNormalized];
      // If currentCategory null, set to first available
      if(!currentCategory){
        if(categories && categories.length) currentCategory = categories[0].id;
        else if(allVideos.length) currentCategory = allVideos[0].category;
      }
      // rebuild active playlist whenever videos change
      buildActivePlaylist();
      renderList();
    }, err => {
      console.error("videos snapshot error", err);
      allVideos = builtinVideos.map(normalizeVideoItem);
      buildActivePlaylist();
      renderList();
    });
  }

  // ---------- Search wiring ----------
  searchInput.addEventListener('input', () => { renderList(); });

  // ---------- Init ----------
  (function init(){
    // start listeners
    startCategoryListener();
    startVideoListener();
    // default UI state
    window.requestAnimationFrame(autoScrollFrame);

    // Load YouTube API (but player won't start until user clicks)
    loadYouTubeIframeAPI();

    // If no categories exist in Firestore, ensure fallback pills appear:
    if(!categories || categories.length === 0){
      categories = defaultCats.map(c => ({ id: c, name: c }));
      if(!currentCategory) currentCategory = categories[0].id;
      renderCategoryBar();
    }
  })();

  // ---------- Prevent easy scraping (non-breaking) ----------
  document.addEventListener('contextmenu', e => e.preventDefault());
  document.addEventListener('selectstart', e => {});
</script>

<script>
// Disable Right Click (non-breaking)
document.addEventListener('contextmenu', function(e) { e.preventDefault(); });

// Disable Key Shortcuts (non-breaking)
document.addEventListener('keydown', function(e) {
    if (e.keyCode == 123) e.preventDefault();
    if (e.ctrlKey && e.shiftKey && (e.keyCode == 73 || e.keyCode == 74)) e.preventDefault();
    if (e.ctrlKey && e.keyCode == 85) e.preventDefault();
    if (e.ctrlKey && (e.keyCode == 83 || e.keyCode == 67)) e.preventDefault();
});
</script>

</body>
</html>
