<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Paiotorr â€” Owner Dashboard (Fixed)</title>
<style>
/* ---------- Base ---------- */
*{box-sizing:border-box}
html,body{margin:0;padding:0;font-family:Arial,sans-serif;background:#fff}
body{padding:20px}

/* Disable text selection except inputs */
*:not(input):not(textarea){user-select:none;-webkit-user-select:none;-moz-user-select:none}

/* HEADER */
.headerBar{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}

/* LAYOUT */
.main{display:grid;grid-template-columns:2fr 1fr;gap:16px}
.pending{border:2px solid #f1c40f;border-radius:12px;padding:14px;height:55vh;overflow-y:auto}
.right{display:grid;grid-template-rows:1fr 1fr;gap:16px;height:55vh}
.box{border-radius:12px;overflow:hidden}
.accepted{border:2px solid #2ecc71}
.rejected{border:2px solid #e74c3c}

/* TITLE + FILTER */
.titleRow{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-bottom:1px solid #ddd;background:#fff}
.filterGroup{display:flex;gap:6px;align-items:center}

/* VISIBLE date display (readonly) */
.dateDisplay{
  width:120px;padding:6px;cursor:pointer;border:1px solid #ccc;border-radius:4px;background:#fff;
  user-select:none;-webkit-user-select:none;-moz-user-select:none;caret-color:transparent;
}

/* HIDDEN native date inputs */
.hiddenDate{
  position:relative;width:1px;height:1px;opacity:0;border:0;margin:0;padding:0;pointer-events:auto;
}

/* Clear button */
.clearBtn{padding:6px 10px;border:none;border-radius:6px;font-size:12px;cursor:pointer;display:none}
.accepted .clearBtn{background:#2ecc71;color:#fff}
.rejected .clearBtn{background:#e74c3c;color:#fff}

/* SCROLL AREA */
.scrollArea{padding:14px;height:calc(55vh - 52px);overflow-y:auto}
.scrollArea::after{content:"";display:block;height:220px} /* ensures last item fully visible */

/* ORDER CARD */
.order{border:2px solid #ccc;border-radius:12px;padding:12px;margin-bottom:12px}
.header{display:flex;justify-content:space-between}
.table{font-weight:bold}
.time{font-size:13px;color:#555}
.customer{font-weight:bold;margin:6px 0}
.item{display:flex;align-items:center;margin-bottom:8px}
.item img{width:70px;height:70px;border-radius:8px;margin-right:10px;object-fit:cover;border:1px solid #ccc}
.itemText{font-weight:bold}
.total{font-weight:bold;margin-top:6px}
.actions button{padding:8px 14px;border:none;border-radius:6px;cursor:pointer;margin-right:6px}
.acceptBtn{background:#2ecc71;color:#fff}
.rejectBtn{background:#e74c3c;color:#fff}

/* AGGREGATED ITEM */
.aggItem{display:flex;align-items:center;border:2px solid #000;border-radius:12px;padding:10px;margin-bottom:12px}
.aggItem img{width:70px;height:70px;border-radius:8px;margin-right:12px;object-fit:cover}

/* ANALYTICS */
.analytics{margin-top:22px;padding-top:16px;border-top:3px solid #000}
.analyticsItem{border:2px solid #000;border-radius:12px;padding:12px;margin-bottom:12px}
.bar{height:14px;border-radius:8px;background:#ddd;overflow:hidden;margin:4px 0}
.acceptBar{background:#2ecc71;height:100%}
.rejectBar{background:#e74c3c;height:100%}
.topBadge{font-size:12px;font-weight:bold;margin-left:6px}

/* debug message */
#debugMsg{margin-top:10px;color:#555;font-size:13px}

/* responsive */
@media(max-width:1020px){.grid{grid-template-columns:1fr}}
.logoutBtn{position:fixed;right:16px;top:16px;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;background:#e74c3c;color:#fff}
</style>
</head>
<body>

<audio id="newOrderSound" preload="auto">
  <source src="https://paiotorr.com/2869-preview.mp3" type="audio/mpeg">
</audio>

<div class="headerBar">
  <h1 id="dashTitle">ðŸ“‹ Paiotorr Dashboard</h1>
  <div>
    <button id="logoutBtn" class="logoutBtn">Logout</button>
  </div>
</div>

<div class="main">

  <div class="pending">
    <h2>ðŸŸ¡ Pending Orders</h2>
    <div id="pending"></div>
  </div>

  <div class="right">

    <div class="box accepted">
      <div class="titleRow">
        <strong>ðŸŸ¢ Accepted</strong>
        <div class="filterGroup">
          <input id="accFromDisplay" class="dateDisplay" type="text" readonly placeholder="DDMMYY">
          <input id="accToDisplay"   class="dateDisplay" type="text" readonly placeholder="DDMMYY">
          <input id="accFrom" class="hiddenDate" type="date" />
          <input id="accTo"   class="hiddenDate" type="date" />
          <button class="clearBtn" id="accClear">Clear</button>
        </div>
      </div>
      <div class="scrollArea" id="accepted"></div>
    </div>

    <div class="box rejected">
      <div class="titleRow">
        <strong>ðŸ”´ Rejected</strong>
        <div class="filterGroup">
          <input id="rejFromDisplay" class="dateDisplay" type="text" readonly placeholder="DDMMYY">
          <input id="rejToDisplay"   class="dateDisplay" type="text" readonly placeholder="DDMMYY">
          <input id="rejFrom" class="hiddenDate" type="date" />
          <input id="rejTo"   class="hiddenDate" type="date" />
          <button class="clearBtn" id="rejClear">Clear</button>
        </div>
      </div>
      <div class="scrollArea" id="rejected"></div>
    </div>

  </div>
</div>

<div class="analytics">
  <h2>ðŸ“Š Top 3 Items</h2>
  <div id="analytics"></div>
</div>

<div id="debugMsg" aria-live="polite"></div>

<script type="module">
/* ===========================
   Firebase imports
   - Assumes /firebase.js exports `auth` and `db`.
   - Use CDN methods for auth state and Firestore operations.
   =========================== */
import { auth, db } from '/firebase.js';
import { onAuthStateChanged, signOut as fbSignOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  collection, query, where, getDocs,
  onSnapshot, doc, updateDoc, Timestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ---------- Helper UI refs ---------- */
const pendingDiv = document.getElementById("pending");
const analyticsDiv = document.getElementById("analytics");
const newOrderSound = document.getElementById("newOrderSound");
const debugMsg = document.getElementById("debugMsg");
const logoutBtn = document.getElementById("logoutBtn");

/* ---------- Safe item images ---------- */
const ITEM_IMAGES = {
  "Paneer Tikka": "https://images.unsplash.com/photo-1599487488170-d11ec9c172f0?w=400",
  "Pav Bhaji": "https://paiotorr.com/image/qwdvdjnnjfgjjknfjkgnjk/cold-drink/15.54.55_53f8bc4d.jpg?w=400",
  "Chicken Curry": "https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=400",
  "Cold Coffee": "https://images.unsplash.com/photo-1541167760496-1628856ab772?w=400",
  "Gulab Jamun": "https://images.unsplash.com/photo-1589119908995-c6837fa14848?w=400",
  "Spring Rolls": "https://images.unsplash.com/photo-1544025162-d76694265947?w=400",
  "Coca Cola": "https://paiotorr.com/image/qwdvdjnnjfgjjknfjkgnjk/cold-drink/15.45.17_4e8d4f82.jpg?w=400",
  "Sprite": "https://paiotorr.com/image/qwdvdjnnjfgjjknfjkgnjk/cold-drink/202615.45.17_e9c762af.jpg?w=400"
};
const DEFAULT_IMG = "https://raw.githubusercontent.com/paiotorr/Paiotorr/main/image/Pizza.jpg";

/* ---------- Date display wiring (existing UX preserved) ---------- */
function formatDisplayDate(iso){ if(!iso) return ""; const parts=iso.split("-"); if(parts.length!==3) return iso; return `${parts[2]}/${parts[1]}/${parts[0]}`; }
function setDisplayFromHidden(hid,disp){ disp.value = hid.value ? formatDisplayDate(hid.value) : ""; }

[
  {disp:"accFromDisplay", hid:"accFrom"},
  {disp:"accToDisplay", hid:"accTo"},
  {disp:"rejFromDisplay", hid:"rejFrom"},
  {disp:"rejToDisplay", hid:"rejTo"},
].forEach(p=>{
  const disp=document.getElementById(p.disp);
  const hid=document.getElementById(p.hid);
  setDisplayFromHidden(hid,disp);
  disp.addEventListener("click",()=>{
    hid.focus();
    setTimeout(()=>{ if(hid.showPicker) try{ hid.showPicker(); }catch(e){ hid.click(); } else hid.click(); },30);
  });
  disp.addEventListener("selectstart",e=>e.preventDefault());
  hid.addEventListener("change",()=>{ setDisplayFromHidden(hid,disp); render(); });
});

/* clear buttons */
document.getElementById("accClear").addEventListener("click",()=>{ document.getElementById("accFrom").value=""; document.getElementById("accTo").value=""; document.getElementById("accFromDisplay").value=""; document.getElementById("accToDisplay").value=""; render(); });
document.getElementById("rejClear").addEventListener("click",()=>{ document.getElementById("rejFrom").value=""; document.getElementById("rejTo").value=""; document.getElementById("rejFromDisplay").value=""; document.getElementById("rejToDisplay").value=""; render(); });

/* ---------- Session / Restaurant ID helpers (FIXED) ---------- */
function getRestaurantIdFromSession() {
  try {
    const s = sessionStorage.getItem("restaurant_session");
    if (!s) return null;
    const j = JSON.parse(s);
    return j?.rid || null;
  } catch (e) {
    console.error("Failed to read restaurant_session:", e);
    return null;
  }
}

function goLogin(){
  // show debug so you can see why redirect occurred
  debugMsg.innerText = "Not authorized â€” redirecting to login...";
  // small delay gives the message a chance to appear, but redirect is immediate enough
  window.location.replace("/maple/owner_login.html");
}

/* ---------- Auth guard: ensures user owns an active restaurant ---------- */
let ordersUnsub = null; // keep snapshot unsubscribe so we don't double-subscribe
onAuthStateChanged(auth, async (user) => {
  try {
    // if not logged in -> redirect
    if (!user) {
      console.warn("No auth user detected.");
      return goLogin();
    }

    // 1) Try to use session-stored restaurant id (saved at login). If present, use it.
    let restaurantId = getRestaurantIdFromSession();

    // 2) If not in session, query Firestore for restaurants owned by this user and pick the first.
    if (!restaurantId) {
      const q = query(collection(db, "restaurants"), where("ownerUID", "==", user.uid));
      const snap = await getDocs(q);
      if (snap.empty) {
        console.warn("No restaurant document found for user:", user.uid);
        return goLogin();
      }
      const docSnap = snap.docs[0];
      restaurantId = docSnap.id;
      // save to session for future loads
      try {
        sessionStorage.setItem("restaurant_session", JSON.stringify({ rid: restaurantId, name: docSnap.data()?.name || "" }));
      } catch(e){ console.warn("Could not write session:", e); }
    }

    // read restaurant doc for status and subscription check
    const restRef = doc(db, "restaurants", restaurantId);
    // get the doc explicitly (not shown here) or reuse previously fetched doc if available.
    // We'll fetch quickly via getDocs again for safety:
    const quickQ = query(collection(db, "restaurants"), where("__name__", "==", restaurantId));
    const quickSnap = await getDocs(quickQ);
    if (quickSnap.empty) {
      console.warn("Restaurant doc not found by ID:", restaurantId);
      return goLogin();
    }
    const restDoc = quickSnap.docs[0];
    const d = restDoc.data();

    // safe subscriptionEnd check
    const end = d?.subscriptionEnd?.toDate?.();
    if (d?.status !== "active") {
      console.warn("Restaurant status not active:", d?.status);
      return goLogin();
    }
    if (!end || new Date() > end) {
      console.warn("Subscription expired or missing:", end);
      return goLogin();
    }

    // OK: authorized â€” set UI title and start orders listener
    window.RESTAURANT_ID = restaurantId;
    document.getElementById("dashTitle").innerText = `ðŸ“‹ Paiotorr â€“ ${ (d?.name || restaurantId).toString().toUpperCase() }`;

    // ensure only one listener
    if (ordersUnsub) ordersUnsub(); 
    initOrdersListener(restaurantId);

    debugMsg.innerText = ""; // clear debug
  } catch (err) {
    console.error("Guard error:", err);
    goLogin();
  }
});

/* ---------- orders snapshot & render logic (similar to your original) ---------- */
let firstLoad = true;
let allOrders = [];
const soundedOrderIds = new Set();
let createdNowIds = new Set();

function initOrdersListener(restaurantId) {
  try {
    const ordersCol = collection(db, "restaurants", restaurantId, "orders");
    ordersUnsub = onSnapshot(ordersCol, snap => {
      let playSound = false;
      let scrollAcc = false;
      let scrollRej = false;
      createdNowIds.clear();

      snap.docChanges().forEach(change=>{
        const docData = change.doc.data();

        // If newly added and has no createdAt, set it ONCE (server Timestamp).
        if (change.type === "added" && !docData.createdAt){
          const ref = doc(db, "restaurants", restaurantId, "orders", change.doc.id);
          updateDoc(ref, { createdAt: Timestamp.now() }).catch(()=>{ /* ignore failures */ });
          createdNowIds.add(change.doc.id);
        }

        if (change.type === "added" && docData.status === "pending" && !firstLoad){
          const id = change.doc.id;
          if(!soundedOrderIds.has(id)){
            soundedOrderIds.add(id);
            playSound = true;
          }
        }

        if((change.type === "added" || change.type === "modified") && !firstLoad){
          const newStatus = change.doc.data()?.status;
          if(newStatus === "accepted") scrollAcc = true;
          if(newStatus === "rejected") scrollRej = true;
        }
      });

      // Build in-memory list using authoritative createdAt when present.
      const orders = [];
      snap.forEach(d=>{
        const o = d.data();
        let createdAt;
        if(o.createdAt && typeof o.createdAt.toDate === "function"){
          createdAt = o.createdAt.toDate();
        } else if(createdNowIds.has(d.id)){
          createdAt = new Date();
        } else {
          createdAt = new Date(0);
        }
        orders.push({ id: d.id, ...o, createdAt });
      });

      // play sound
      if(playSound){
        newOrderSound.currentTime = 0;
        newOrderSound.play().catch(()=>{});
      }

      firstLoad = false;
      orders.sort((a,b)=> b.createdAt - a.createdAt);
      allOrders = orders;
      render();

      // scroll effects
      if(playSound && pendingDiv.parentElement){ pendingDiv.parentElement.scrollTop = 0; }
      if(scrollAcc){ const el = document.getElementById("accepted"); if(el) el.scrollTop = 0; }
      if(scrollRej){ const el = document.getElementById("rejected"); if(el) el.scrollTop = 0; }
    }, err => {
      console.error("Orders snapshot error:", err);
      debugMsg.innerText = "Realtime listener error (see console).";
    });
  } catch(e){
    console.error("initOrdersListener error:", e);
    debugMsg.innerText = "Failed to start orders listener.";
  }
}

/* ---------- render code (keeps your original UX) ---------- */
function render(){
  renderPending();
  renderBox("accepted", document.getElementById("accFrom"), document.getElementById("accTo"), document.getElementById("accClear"));
  renderBox("rejected", document.getElementById("rejFrom"), document.getElementById("rejTo"), document.getElementById("rejClear"));
  renderAnalytics();
}

function renderPending(){
  pendingDiv.innerHTML = "";
  const list = allOrders.filter(o=>o.status==="pending");
  list.forEach(o => renderSingleOrder(o, pendingDiv, true));
}

function renderBox(status, from, to, clearBtn){
  let list = allOrders.filter(o=>o.status===status);
  const container = document.getElementById(status);
  container.innerHTML = "";

  if(from.value && to.value){
    clearBtn.style.display = "inline-block";
    const f = new Date(from.value);
    const t = new Date(to.value); t.setHours(23,59,59,999);
    list = list.filter(o=>o.createdAt >= f && o.createdAt <= t);
    renderAggregated(list, container, status);
  } else {
    clearBtn.style.display = "none";
    list.forEach(o=>renderSingleOrder(o,container,false));
  }
}

function renderSingleOrder(o, container, actions){
  let items = "";
  (o.items||[]).forEach(i=>{
    const img = i.img || ITEM_IMAGES[i.name] || DEFAULT_IMG;
    items += `<div class="item"><img src="${img}" onerror="this.onerror=null;this.src='${DEFAULT_IMG}'"><div class="itemText">${escapeHtml(i.name)} Ã— ${i.qty}</div></div>`;
  });

  const timeText = o.createdAt && o.createdAt.getTime() !== 0 ? o.createdAt.toLocaleString() : "â€”";

  const html = `
    <div class="order" data-id="${o.id}">
      <div class="header"><div class="table">Table ${escapeHtml(String(o.table||"â€”"))}</div><div class="time">${escapeHtml(timeText)}</div></div>
      <div class="customer">ðŸ‘¤ ${escapeHtml(o.customer||"â€”")}</div>
      ${items}
      <div class="total">â‚¹${escapeHtml(String(o.total||0))}</div>
      ${actions?`<div class="actions"><button class="acceptBtn" onclick="setStatus('${o.id}','accepted')">Accept</button><button class="rejectBtn" onclick="setStatus('${o.id}','rejected')">Reject</button></div>`:""}
    </div>`;

  container.insertAdjacentHTML("beforeend", html);
}

function renderAggregated(list, container, status){
  const map = {};
  list.forEach(o=> (o.items||[]).forEach(i=>{
    if(!map[i.name]) map[i.name] = { qty:0, img: i.img || ITEM_IMAGES[i.name] || DEFAULT_IMG };
    map[i.name].qty += i.qty;
  }));

  const sortedItems = Object.entries(map)
    .map(([name,data]) => ({ name, qty: data.qty, img: data.img || DEFAULT_IMG }))
    .sort((a,b) => b.qty - a.qty);

  container.innerHTML = "";

  sortedItems.forEach(item=>{
    container.insertAdjacentHTML("beforeend",`
      <div class="aggItem">
        <img src="${item.img}" onerror="this.onerror=null;this.src='${DEFAULT_IMG}'">
        <div><b>${escapeHtml(item.name)}</b><br>${status==="accepted"?"Accepted":"Rejected"}: ${item.qty}</div>
      </div>
    `);
  });
}

function renderAnalytics(){
  const stats = {};
  allOrders.forEach(o=> (o.items||[]).forEach(i=>{
    if(!stats[i.name]) stats[i.name] = { total:0, accepted:0, rejected:0 };
    stats[i.name].total += i.qty;
    if(o.status==="accepted") stats[i.name].accepted += i.qty;
    if(o.status==="rejected") stats[i.name].rejected += i.qty;
  }));
  analyticsDiv.innerHTML = "";
  Object.entries(stats).sort((a,b)=>b[1].total - a[1].total).slice(0,3).forEach(([name,data],i)=>{
    const accP = data.total ? Math.round(data.accepted/data.total*100) : 0;
    const rejP = data.total ? Math.round(data.rejected/data.total*100) : 0;
    analyticsDiv.insertAdjacentHTML("beforeend",`
      <div class="analyticsItem">
        <b>${escapeHtml(name)}</b>
        <span class="topBadge">Top ${i+1}</span>
        <div>Total Orders: <b>${data.total}</b></div>
        <div>Accepted: ${data.accepted} (${accP}%)</div><div class="bar"><div class="acceptBar" style="width:${accP}%"></div></div>
        <div>Rejected: ${data.rejected} (${rejP}%)</div><div class="bar"><div class="rejectBar" style="width:${rejP}%"></div></div>
      </div>
    `);
  });
}

/* ---------- update status (DO NOT overwrite createdAt) ---------- */
window.setStatus = async (id, status) => {
  try {
    await updateDoc(doc(db,"restaurants", window.RESTAURANT_ID, "orders", id), { status });
  } catch(e){
    console.error("Failed to update status", e);
    debugMsg.innerText = "Failed to update order status.";
  }
};

/* helper */
function escapeHtml(s){ return s ? String(s).replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])) : ""; }

/* ---------- logout ---------- */
logoutBtn.addEventListener('click', async () => {
  try {
    await fbSignOut(auth);
    sessionStorage.removeItem('restaurant_session');
    if (ordersUnsub) ordersUnsub();
    window.location.href = "/maple/owner_login.html";
  } catch(e) {
    console.error("Logout failed:", e);
  }
});

/* ---------- security (same as before) ---------- */
document.addEventListener('contextmenu', e=>e.preventDefault());
document.addEventListener('keydown', e=>{
  const forbidden = ['c','v','x','u','s'];
  if((e.ctrlKey || e.metaKey) && forbidden.includes(e.key.toLowerCase())) e.preventDefault();
  if(e
