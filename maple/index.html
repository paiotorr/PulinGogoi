<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=1280, initial-scale=0.3, maximum-scale=0.3, minimum-scale=0.3, user-scalable=no">
<meta name="copyright" content="¬© 2026 Paiotorr">
<meta name="author" content="Paiotorr">
<title>PAIOTORR - MAPLE</title>

<style>
/* --- BASE STYLES --- */
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  scroll-behavior: smooth;
  background: #f8f8f8;
  font-family: Arial, sans-serif;
  min-width: 1280px; 
  overflow-x: hidden;
  touch-action: manipulation;
  user-select: none;
  -webkit-user-select: none;
}

h1 { text-align: center; font-size: 90px; margin-top: 90px; }
#tableInfo { text-align: center; font-weight: bold; font-size: 60px; color: #555; }

#mainMenuContainer { padding-bottom: 50px; }

#copyrightFooter {
  display: block;
  text-align: center;
  font-size: 40px;
  color: #888;
  background: #f8f8f8;
  font-weight: bold;
  margin-top: 50px;
  padding-bottom: 1000px;
  width: 100%;
}

/* --- CATEGORY HEADERS --- */
.category-header {
  display: flex;
  align-items: center;
  text-align: center;
  font-size: 60px;
  font-weight: 900;
  color: #000;
  margin: 80px 0 40px 0;
  text-transform: uppercase;
  padding: 15px;
}
.category-header::before, .category-header::after {
  content: "";
  flex: 1;
  border-bottom: 6px solid #000;
}
.category-header::before { margin-right: 30px; }
.category-header::after { margin-left: 30px; }

@keyframes redFlash {
  0% { background-color: transparent; color: #000; }
  50% { background-color: #e74c3c; color: #fff; }
  100% { background-color: transparent; color: #000; }
}
.header-flash-red { animation: redFlash 1.2s ease-in-out; }

/* --- MENU ITEMS --- */
.menu { display: flex; gap: 40px; justify-content: center; flex-wrap: wrap; padding: 0 40px; }
.item {
  background: #fff;
  border: 2px solid #ddd;
  width: 500px;
  padding: 30px;
  text-align: center;
  border-radius: 20px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.05);
  flex: 0 0 500px;
}
.item img { 
  width: 100%; height: 300px; object-fit: cover; border-radius: 16px; 
  pointer-events: none;
  -webkit-user-drag: none;
}
.item h3 { font-size: 52px; margin: 15px 0; }
.item p { font-size: 48px; color: #27ae60; font-weight: bold; margin-bottom: 20px; }

/* ADD button ‚Äî must remain exactly as original initial state */
.add-btn { 
  width: 100%;
  padding: 62px;
  font-size: 54px;
  font-weight: bold; 
  background: #3498db;
  color: #fff;
  border: none;
  border-radius: 22px; 
  cursor: pointer;
  transition: transform 0.1s, background-color 0.1s;
}

/* QUANTITY CONTROLLER: replaces add button when active */
.quantity-controller {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
  padding: 32px 32px; /* visually similar to add-btn */
  font-size: 54px;
  font-weight: bold;
  border-radius: 22px;
  box-sizing: border-box;
  border: 6px solid #27ae60; /* GREEN STROKE when visible */
  background: #fff;
  gap: 20px;
}
.quantity-controller .qty-btn {
  width: 120px;
  height: 70px;
  font-size: 54px;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  background: transparent;
}
.quantity-controller .qty-number {
  flex: 1;
  text-align: center;
  font-size: 54px;
  font-weight: 900;
  user-select: none;
}

/* --- BOTTOM ORDER PANEL --- */
#orderBox {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background: #fff;
  border-top: 6px solid #27ae60;
  z-index: 9999;
  box-shadow: 0 -10px 40px rgba(0,0,0,0.3);
  overscroll-behavior: contain;
}

#orderInner { max-width: 1100px; margin: auto; padding: 25px; box-sizing: border-box; }

#categoryNavigationBox {
  border: 3px solid #000;
  border-radius: 15px;
  padding: 12px;
  margin-bottom: 20px;
  overflow: hidden;
  position: relative;  
}

#catBar {
  display: flex;
  overflow-x: auto;
  white-space: nowrap;
  gap: 20px;
  padding: 10px;
  scrollbar-width: none;
  touch-action: pan-x; 
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;
  scroll-behavior: auto; 
}
#catBar::-webkit-scrollbar { display: none; }

.cat-btn {
  flex: 0 0 auto;
  padding: 18px 50px;
  font-size: 55px;
  font-weight: bold;
  border: 5px solid transparent; 
  border-radius: 60px;
  color: white;
  cursor: pointer;
  transition: transform 0.1s ease-in-out, filter 0.1s; 
}
.cat-veg { background: #27ae60 !important; }
.cat-non-veg { background: #e74c3c !important; }
.cat-drinks { background: #2980b9 !important; }
.cat-starters { background: #f39c12 !important; }
.cat-desserts { background: #9b59b6 !important; }
.cat-chips { background: #ff002b !important; }
.cat-cold-drink { background: #04947c !important; }

.visual-click {
  transform: scale(0.92) !important;
  filter: brightness(1.2) !important;
  border: 5px solid #000000 !important;
  box-shadow: 0 0 15px rgba(0,0,0,0.3) !important;
}

/* repurposed input box styles (kept same size & look) */
#customerName {
  width: 100%; padding: 22px; font-size: 30px; font-weight: 900;
  margin-bottom: 20px; border: 3px solid #ddd; border-radius: 15px;
  box-sizing: border-box;
  user-select: text; 
  -webkit-user-select: text;
}

#orderList {
  max-height: 300px; 
  overflow-y: auto;
  margin-bottom: 15px;
  touch-action: pan-y;
  overscroll-behavior: contain;
}

/* Order items ‚Äî display only (no interactive controls) */
.order-item { 
  display: flex; justify-content: space-between; align-items: center; 
  margin-bottom: 13px; padding: 12px; background: #f1f1f1; 
  border-radius: 16px; height: auto; 
}
.order-name { font-size: 48px; font-weight: 800; }

#totalPrice { text-align: center; font-size: 50px; font-weight: 900; margin-bottom: 15px; }

.submit-btn { 
  width: 100%; padding: 40px; font-size: 42px; font-weight: bold; 
  background: #27ae60; color: #fff; border: none; border-radius: 25px; 
  cursor: pointer;
  transition: transform 0.1s ease-in-out, filter 0.1s; 
  border: 5px solid transparent; 
}

/* POPUP */
#popup { position: fixed; inset: 0; background: rgba(0,0,0,.85); display: none; align-items: center; justify-content: center; z-index: 10000; }
.popup-box { background: #fff; width: 550px; padding: 60px; text-align: center; border-radius: 35px; position: relative; }
</style>
</head>

<body>

<h1>PAIOTORR - MAPLE</h1>
<p id="tableInfo"></p>

<div id="mainMenuContainer"></div>

<div id="copyrightFooter">
  ¬© 2026 Paiotorr. All Rights Reserved.
</div>

<div id="orderBox">
  <div id="orderInner">
    <div id="categoryNavigationBox">
      <div id="catBar"></div>
    </div>

    <input id="customerName" placeholder="Optional: order requirements / special instructions (e.g., Less salt, No onion, Extra spoon)">

    <div id="orderList"></div>
    <div id="totalPrice"></div>
    <button class="submit-btn" onclick="submitOrder(this)">üõé SUBMIT ORDER</button>
  </div>
</div>

<div id="popup">
  <div class="popup-box">
    <div id="closeBtn" style="position:absolute;top:20px;right:25px;font-size:45px;cursor:pointer;color:#e74c3c" onclick="manualClose()">‚úñ</div>
    <div id="popupIcon" style="font-size:130px"></div>
    <div id="popupText" style="font-size:36px;font-weight:bold;margin-top:20px"></div>
    <div id="popupPrice" style="font-size:34px;font-weight:900;margin-top:15px"></div>
  </div>
</div>

<script type="module">
/* ========== Firebase imports & init (keep inside module) ========== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import {
  getFirestore,
  collection,
  addDoc,
  doc,
  onSnapshot,
  updateDoc,
  getDoc
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

/* --- SECURITY & COPYRIGHT PROTECTION --- */
document.addEventListener("contextmenu", (e) => e.preventDefault());
document.addEventListener("keydown", (e) => {
  if (e.ctrlKey && (e.key === "u" || e.key === "U" || e.key === "s" || e.key === "S" || e.key === "c" || e.key === "C")) {
    e.preventDefault();
  }
});
document.addEventListener("dragstart", (e) => {
  if (e.target.tagName === "IMG") {
    e.preventDefault();
  }
});

/* ========== Firebase app & DB ========== */
const app = initializeApp({
 apiKey:"AIzaSyDSf51jWs3I4AXX0U8M_HxKn4VtRYg72xs",
 authDomain:"hotel-order-7f1f2.firebaseapp.com",
 projectId:"hotel-order-7f1f2"
});
const db = getFirestore(app);

/* ===== STEP 3: TABLE / ROOM VALIDATION (top-level await is used) ===== */
const params = new URLSearchParams(location.search);

const identifierType =
  params.get("type") ||
  (params.get("table") ? "table" : (params.get("room") ? "room" : null));

const identifierNumber =
  params.get("table") || params.get("room") || params.get("num") || null;

if (!identifierNumber || !identifierType) {
  document.body.innerHTML = "Invalid table / room (missing parameter)";
  throw new Error("Blocked: missing identifier");
}

const checker = await getDoc(
  doc(
    db,
    "restaurants",
    "maple",
    "allowedIdentifiers",
    `${identifierType}_${identifierNumber}`
  )
);

if (!checker.exists()) {
  document.body.innerHTML = "Invalid table / room number";
  throw new Error("Blocked: not allowed");
}
/* ===== END STEP 3 ===== */

/* ===== Backwards compatibility: table variable used across page ===== */
const restaurantId = "maple";
const table = identifierNumber; // keep original 'table' variable for legacy usage
tableInfo.innerText = "Table: " + table;

/* ========== Menu data & constants ========== */
const menuData = [
  { name: "Paneer Tikka", price: 180, category: "Starters", img: "https://images.unsplash.com/photo-1599487488170-d11ec9c172f0?w=400" },
  { name: "Pav Bhaji", price: 199, category: "Veg", img: "https://paiotorr.com/image/qwdvdjnnjfgjjknfjkgnjk/cold-drink/15.54.55_53f8bc4d.jpg?w=400" },
  { name: "Chicken Curry", price: 280, category: "Non-Veg", img: "https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=400" },
  { name: "Cold Coffee", price: 90, category: "Drinks", img: "https://images.unsplash.com/photo-1541167760496-1628856ab772?w=400" },
  { name: "Gulab Jamun", price: 60, category: "Desserts", img: "https://images.unsplash.com/photo-1589119908995-c6837fa14848?w=400" },
  { name: "Spring Rolls", price: 120, category: "Starters", img: "https://images.unsplash.com/photo-1544025162-d76694265947?w=400" },
  { name: "Coca Cola", price: 40, category: "Cold-Drink", img: "https://paiotorr.com/image/qwdvdjnnjfgjjknfjkgnjk/cold-drink/15.45.17_4e8d4f82.jpg?w=400" },
  { name: "Sprite", price: 40, category: "Cold-Drink", img: "https://paiotorr.com/image/qwdvdjnnjfgjjknfjkgnjk/cold-drink/202615.45.17_e9c762af.jpg?w=400" }
];

const POPUP_KEY = `popup_${restaurantId}_${table}`;
const ORDER_KEY = `order_${restaurantId}_${table}`;

const TIME_SUBMITTED = 8 * 60 * 1000; 
const TIME_RESULT = 5 * 60 * 1000;    

const orderBox = document.getElementById("orderBox");
const orderList = document.getElementById("orderList");
const catBar = document.getElementById("catBar");
let order = {};
let total = 0;

orderBox.addEventListener('touchmove', (e) => {
    const isScrollable = orderList.contains(e.target) || catBar.contains(e.target);
    if (!isScrollable) e.preventDefault(); 
}, { passive: false });

window.triggerVisual = (element) => {
  if(!element) return;
  element.classList.remove('visual-click');
  void element.offsetWidth; 
  element.classList.add('visual-click');
  setTimeout(() => element.classList.remove('visual-click'), 200); 
}

let autoScroll = true;
let scrollDir = 1; 
const SCROLL_SPEED = 2; 

function initInfiniteCat() {
    const el = document.getElementById('catBar');
    function step() {
        if (autoScroll) {
            const maxScroll = el.scrollWidth - el.clientWidth;
            if (maxScroll > 0) {
              el.scrollLeft += (SCROLL_SPEED * scrollDir);
              if (scrollDir === 1 && el.scrollLeft >= maxScroll - 5) scrollDir = -1;
              else if (scrollDir === -1 && el.scrollLeft <= 5) scrollDir = 1;
            }
        }
        requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
    el.addEventListener('touchstart', () => autoScroll = false);
    el.addEventListener('touchend', () => setTimeout(() => autoScroll = true, 2000));
}

function initMenu() {
  const container = document.getElementById("mainMenuContainer");
  const categories = [...new Set(menuData.map(i => i.category))];
  const loopCats = Array(30).fill(categories).flat();

  loopCats.forEach((cat) => {
    const safeName = cat.toLowerCase().replace(/\s+/g, '-');
    const btn = document.createElement("button");
    btn.innerText = cat; 
    btn.className = `cat-btn cat-${safeName}`;
    btn.onclick = () => {
      triggerVisual(btn); 
      const section = document.getElementById(`sec-${safeName}`);
      if(section) {
        window.scrollTo({ top: section.offsetTop - 20, behavior: 'smooth' });
        const targetHeader = section.querySelector(`.category-header`);
        targetHeader.classList.remove('header-flash-red'); 
        void targetHeader.offsetWidth; 
        targetHeader.classList.add('header-flash-red');
      }
    };
    catBar.appendChild(btn);
  });

  categories.forEach(cat => {
    const safeName = cat.toLowerCase().replace(/\s+/g, '-');
    const section = document.createElement("div");
    section.id = `sec-${safeName}`;
    const items = menuData.filter(i => i.category === cat);
    section.innerHTML = `
      <div class="category-header">${cat}</div>
      <div class="menu">
        ${items.map((i, idx) => `
          <div class="item">
            <img src="${i.img}">
            <h3>${i.name}</h3><p>‚Çπ${i.price}</p>
            <!-- ADD button: initial state (unchanged appearance) -->
            <button class="add-btn" data-item-index="${idx}" data-item-name="${i.name}" data-item-price="${i.price}"
              onclick="handleAddButtonClick(this, '${i.name.replace(/'/g,"\\'")}', ${i.price})">‚ûï ADD</button>
          </div>`).join('')}
      </div>`;
    container.appendChild(section);
  });
  initInfiniteCat();
}

/* ---------------------------
   ADD ‚Üí QUANTITY CONTROLLER
   --------------------------- */
window.handleAddButtonClick = (btn, name, price) => {
  if (!btn) return;
  triggerVisual(btn);
  if (order[name] && order[name].qty > 0) return;
  order[name] = { name, price, qty: 1 };
  const controller = createQuantityController(btn, name, price);
  btn.replaceWith(controller);
  render();
};

function createQuantityController(existingBtn, name, price) {
  const wrapper = document.createElement("div");
  wrapper.className = "quantity-controller";
  wrapper.setAttribute("data-item-name", name);

  const minus = document.createElement("button");
  minus.className = "qty-btn minus";
  minus.type = "button";
  minus.innerText = "‚àí";

  const num = document.createElement("div");
  num.className = "qty-number";
  num.innerText = order[name] ? String(order[name].qty) : "1";

  const plus = document.createElement("button");
  plus.className = "qty-btn plus";
  plus.type = "button";
  plus.innerText = "+";

  plus.addEventListener("click", (e) => {
    e.stopPropagation();
    triggerVisual(plus);
    if (!order[name]) order[name] = { name, price, qty: 0 };
    order[name].qty = (order[name].qty || 0) + 1;
    num.innerText = String(order[name].qty);
    render();
  });

  minus.addEventListener("click", (e) => {
    e.stopPropagation();
    triggerVisual(minus);
    if (!order[name]) return;
    order[name].qty = (order[name].qty || 0) - 1;
    if (order[name].qty <= 0) {
      delete order[name];
      const addBtn = createAddButton(name, price);
      wrapper.replaceWith(addBtn);
    } else {
      num.innerText = String(order[name].qty);
    }
    render();
  });

  wrapper.appendChild(minus);
  wrapper.appendChild(num);
  wrapper.appendChild(plus);

  return wrapper;
}

function createAddButton(name, price) {
  const btn = document.createElement("button");
  btn.className = "add-btn";
  btn.innerText = "‚ûï ADD";
  btn.setAttribute("data-item-name", name);
  btn.setAttribute("data-item-price", price);
  btn.onclick = function() { handleAddButtonClick(btn, name, price); };
  return btn;
}

/* ---------------------------
   Render bottom order list
   --------------------------- */
function render() {
  const list = document.getElementById("orderList");
  list.innerHTML = "";
  total = 0;

  Object.values(order).forEach(o => {
    if (!o || !o.qty || o.qty <= 0) return;
    total += o.price * o.qty;
    const row = document.createElement("div");
    row.className = "order-item";
    row.innerHTML = `<span class="order-name">${o.name} √ó ${o.qty}</span><span class="order-price">‚Çπ${o.price * o.qty}</span>`;
    list.appendChild(row);
  });

  document.getElementById("totalPrice").innerText = total ? "Total: ‚Çπ" + total : "";
}

/* ---------------------------
   submitOrder & popup logic
*/
window.submitOrder = async(btnElement) => {
  triggerVisual(btnElement);
  const instructionsInput = document.getElementById("customerName"); // repurposed input

  if (!Object.keys(order).length) {
    return alert("Please add items before submitting the order.");
  }

  // ===== payload updated for security rules (identifierType + identifierNumber required) =====
  const payload = {
    identifierType,
    identifierNumber: Number(identifierNumber),
    table: identifierNumber, // keep old field for owner UI backwards compatibility
    items: Object.values(order),
    total,
    status: "pending",
    submittedAt: Date.now()
  };

  const instr = (instructionsInput && String(instructionsInput.value || "").trim());
  if (instr) {
    payload.instructions = instr;      // explicit instructions field
    payload.customer = instr;          // also store into 'customer' so owner page (which displays name) will show instructions
  }

  const ref = await addDoc(collection(db, "restaurants", restaurantId, "orders"), payload);

  localStorage.setItem(ORDER_KEY, ref.id);
  savePopup("submitted", total);
  listen(ref.id);
  order = {}; render(); instructionsInput.value = "";

  // revert visible controllers back to add buttons
  document.querySelectorAll('.quantity-controller').forEach(ctrl => {
    const nm = ctrl.getAttribute('data-item-name');
    const pr = (nm && menuData.find(m => m.name === nm)) ? menuData.find(m => m.name === nm).price : 0;
    const addBtn = createAddButton(nm, pr);
    ctrl.replaceWith(addBtn);
  });
};

function listen(id) {
  onSnapshot(doc(db, "restaurants", restaurantId, "orders", id), s => {
    if(!s.exists()) return;
    const d = s.data();
    
    const lockKey = `done_${id}_${d.status}`;
    if(localStorage.getItem(lockKey)) return;

    const stored = JSON.parse(localStorage.getItem(POPUP_KEY) || "{}");
    if (d.status !== stored.status) {
      if (d.status === "accepted" || d.status === "rejected") {
        savePopup(d.status, d.total);
      }
    }
  });
}

// savePopup stores only status + price + start time (no input inclusion)
function savePopup(status, price) {
  localStorage.setItem(POPUP_KEY, JSON.stringify({status, price, start: Date.now()}));
  showPopup();
}

function checkPopupTimer() {
  const data = localStorage.getItem(POPUP_KEY);
  if(!data) {
     if(document.getElementById("popup").style.display === "flex") {
        document.getElementById("popup").style.display = "none";
     }
     return;
  }

  const p = JSON.parse(data);
  const elapsed = Date.now() - p.start;
  const limit = (p.status === "submitted") ? TIME_SUBMITTED : TIME_RESULT;

  if (elapsed >= limit) {
    const orderId = localStorage.getItem(ORDER_KEY);
    if(orderId) localStorage.setItem(`done_${orderId}_${p.status}`, "true");
    
    document.getElementById("popup").style.display = "none";
    localStorage.removeItem(POPUP_KEY);
  }
}
setInterval(checkPopupTimer, 1000);

function showPopup() {
  const data = localStorage.getItem(POPUP_KEY);
  const orderId = localStorage.getItem(ORDER_KEY);
  
  if(!data || !orderId) return;
  const p = JSON.parse(data);

  if(localStorage.getItem(`done_${orderId}_${p.status}`)) return;

  const popup = document.getElementById("popup");
  popup.style.display = "flex";
  document.getElementById("closeBtn").style.display = (p.status === "submitted") ? "none" : "block";
  document.getElementById("popupIcon").innerHTML = p.status === "accepted" ? "‚úî" : p.status === "rejected" ? "‚úñ" : "‚è≥";

  const mapping = {
    submitted: "Order Submitted",
    accepted: "Order Accepted",
    rejected: "Order Rejected"
  };
  const text = mapping[p.status] || "Order Status";
  document.getElementById("popupText").innerText = text;
  document.getElementById("popupPrice").innerText = p.price ? `‚Çπ${p.price}` : "";
}

function manualClose() {
  const orderId = localStorage.getItem(ORDER_KEY);
  if (!orderId) return;
  const data = JSON.parse(localStorage.getItem(POPUP_KEY) || "{}");
  if (data.status === "submitted") return;
  localStorage.setItem(`done_${orderId}_${data.status}`, "true");
  document.getElementById("popup").style.display = "none";
}

/* initialize UI */
initMenu();
render();
</script>
</body>
</html>
