<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Team Video Submission · JoiZubeenDa</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta http-equiv="X-Frame-Options" content="DENY">

<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:Arial,Helvetica,sans-serif;background:#fafafa;color:#000;min-height:100vh}
header{background:#000;color:#fff;padding:16px;text-align:center;display:flex;align-items:center;justify-content:space-between;gap:12px}
header h1{font-size:20px;margin:0}
.header-actions{display:flex;gap:8px;align-items:center}
.header-actions button{background:transparent;border:1px solid rgba(255,255,255,0.18);color:#fff;padding:8px 10px;border-radius:8px;cursor:pointer}
.header-actions button:hover{opacity:0.92}
main{max-width:520px;margin:30px auto;padding:0 14px}
.card{background:#fff;border-radius:10px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
label{display:block;font-size:13px;font-weight:700;margin-bottom:6px}
input,select,button{
  width:100%;padding:11px 12px;margin-bottom:14px;
  border-radius:6px;border:1px solid #ccc;font-size:14px
}
button.primary{background:#000;color:#fff;border:none;font-weight:700;cursor:pointer}
.preview{display:none;margin-top:10px;border-top:1px solid #eee;padding-top:14px}
.preview img{width:100%;border-radius:6px}
.preview-title{font-size:14px;font-weight:700;margin-top:8px}
.status{font-size:13px;margin-top:10px;min-height:20px}
.status.ok{color:green}
.status.err{color:#c00}
footer{text-align:center;font-size:12px;color:#777;padding:18px 10px 24px}
</style>
</head>

<body>

<header>
  <h1>Video Submission</h1>
  <div class="header-actions">
    <button id="btnLogout">Logout</button>
  </div>
</header>

<main>
  <div class="card">

    <label for="videoUrl">YouTube Video URL</label>
    <input id="videoUrl" type="url" placeholder="https://youtu.be/..." required>

    <label for="category">Select Category</label>
    <select id="category" aria-label="Select category"></select>

    <button id="addBtn" class="primary">Add Video</button>

    <div class="preview" id="preview">
      <img id="thumb" alt="Thumbnail">
      <div class="preview-title" id="videoTitle"></div>
    </div>

    <div class="status" id="status"></div>

  </div>
</main>

<footer>© 2026 JoiZubeenDa · Internal Team Tool</footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import {
    getFirestore, collection, doc, getDoc, addDoc, setDoc,
    onSnapshot, serverTimestamp,
    query, where, getDocs
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // ---------- Firebase config ----------
  const firebaseConfig = {
    apiKey: "AIzaSyC6cMfvfX68H-luCgPa32aXAc0D-x6bczU",
    authDomain: "zubeenda-17222.firebaseapp.com",
    projectId: "zubeenda-17222",
    storageBucket: "zubeenda-17222.firebasestorage.app",
    messagingSenderId: "541676751696",
    appId: "1:541676751696:web:e75867164d4372d3ad7a55"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ---------- DOM ----------
  const videoUrlEl = document.getElementById("videoUrl");
  const categoryEl = document.getElementById("category");
  const addBtn = document.getElementById("addBtn");
  const previewEl = document.getElementById("preview");
  const thumbEl = document.getElementById("thumb");
  const videoTitleEl = document.getElementById("videoTitle");
  const statusEl = document.getElementById("status");
  const btnLogout = document.getElementById("btnLogout");

  // ---------- Helpers ----------
  // Improved ID extractor and URL validation (supports: youtube.com/watch?v=  youtu.be/  youtube.com/shorts/)
  function ytId(url){
    if(!url) return null;
    try {
      const u = new URL(url);
      const host = (u.hostname || '').replace('www.','').toLowerCase();
      // youtu.be short link
      if(host === 'youtu.be') {
        const id = u.pathname.slice(1);
        return id || null;
      }
      // youtube hosts
      if(host.endsWith('youtube.com') || host === 'youtube.com' || host === 'm.youtube.com'){
        // watch?v=
        if(u.pathname === '/watch'){
          return u.searchParams.get('v') || null;
        }
        // shorts: /shorts/<id>
        if(u.pathname.startsWith('/shorts/')){
          const parts = u.pathname.split('/');
          return parts[2] || null;
        }
        // embed: /embed/<id>
        const embedMatch = u.pathname.match(/\/embed\/([A-Za-z0-9_-]+)/);
        if(embedMatch) return embedMatch[1];
        // fallback: try search param v
        if(u.searchParams.get('v')) return u.searchParams.get('v');
      }
      return null;
    } catch(e){
      return null;
    }
  }

  function ytThumb(id){ return id ? `https://img.youtube.com/vi/${id}/hqdefault.jpg` : ''; }
  function nowReadable(){ return new Date().toLocaleString(); }
  function setStatus(text, ok){
    statusEl.textContent = text || "";
    statusEl.className = ok ? "status ok" : (text ? "status err" : "status");
  }

  // Fetch title using YouTube oEmbed (recommended — no API key)
  // If oEmbed fails (CORS or network), we fallback to a simple id-based title.
  async function fetchYouTubeTitle(originalUrl, idFallback){
    const oembedUrl = `https://www.youtube.com/oembed?url=${encodeURIComponent(originalUrl)}&format=json`;
    try {
      const res = await fetch(oembedUrl);
      if(!res.ok) throw new Error('oEmbed returned ' + res.status);
      const data = await res.json();
      if(data && data.title) return data.title;
      throw new Error('Invalid oEmbed response');
    } catch (err) {
      // fallback: return a predictable title instead of failing completely
      console.warn('YouTube oEmbed failed:', err);
      return `YouTube · ${idFallback || 'unknown'}`;
    }
  }

  // ---------- Auth & Role Guard (team only) ----------
  let currentUser = null;
  onAuthStateChanged(auth, async (user) => {
    if(!user){
      sessionStorage.removeItem("jzd_session");
      location.replace("login.html");
      return;
    }
    currentUser = user;
    try {
      const udoc = await getDoc(doc(db, "users", user.uid));
      if(!udoc.exists()){
        alert("No role assigned. Contact admin.");
        await signOut(auth);
        location.replace("login.html");
        return;
      }
      const u = udoc.data();
      if(u.role !== "team"){
        if(u.role === "admin"){
          location.replace("admin.html");
        } else {
          alert("Team access required.");
          await signOut(auth);
          location.replace("login.html");
        }
        return;
      }

      sessionStorage.setItem("jzd_session", JSON.stringify({
        uid: user.uid,
        email: user.email,
        role: u.role,
        name: u.name || ""
      }));

      // Start real-time category listener
      startCategoryListener();

    } catch (err) {
      console.error(err);
      alert("Auth verification failed. Re-login required.");
      await signOut(auth);
      location.replace("login.html");
    }
  });

  // ---------- Categories (real-time) ----------
  let categoriesUnsub = null;
  function startCategoryListener(){
    if(categoriesUnsub) categoriesUnsub();
    const col = collection(db, "categories");
    categoriesUnsub = onSnapshot(col, snap => {
      categoryEl.innerHTML = "";
      const arr = [];
      snap.forEach(d => {
        const data = d.data();
        arr.push({ id: d.id, name: data.name || d.id });
      });
      if(arr.length === 0){
        // fallback if no categories present
        const fallback = ['song','live','interview'];
        fallback.forEach(c => {
          const opt = document.createElement("option");
          opt.value = c;
          opt.textContent = c;
          categoryEl.appendChild(opt);
        });
        return;
      }
      arr.sort((a,b)=> a.name.localeCompare(b.name));
      arr.forEach(item => {
        const opt = document.createElement("option");
        opt.value = item.id;
        opt.textContent = item.name;
        categoryEl.appendChild(opt);
      });
    }, err => {
      console.error("categories snapshot error", err);
    });
  }

  // ---------- Add video ----------
  addBtn.addEventListener("click", async () => {
    setStatus("", false);
    const url = (videoUrlEl.value || "").trim();
    const categoryId = categoryEl.value;
    const id = ytId(url);

    if(!id){
      setStatus("Invalid or unsupported YouTube URL. Supported: youtube.com/watch?v=, youtu.be/, youtube.com/shorts/", false);
      return;
    }
    if(!categoryId){
      setStatus("Please select a category", false);
      return;
    }

    addBtn.disabled = true;
    addBtn.textContent = "Adding...";

    try {
      const thumb = ytThumb(id);

      // Fetch the real title from YouTube (oEmbed). Fallback to id-based title if oEmbed fails.
      const title = await fetchYouTubeTitle(url, id);

      // Prepare canonical save fields required by system
      const videoDoc = {
        videoId: id,
        videoUrl: url,
        videoTitle: title,
        // keep older fields for compatibility with other pages
        id,
        url,
        category: categoryId,
        thumb,
        title,
        addedBy: currentUser.email || "",
        createdAt: serverTimestamp(),
        time: nowReadable()
      };

      // ---------- DUPLICATE CHECKS ----------
      // 1) Check by videoId
      const qById = query(collection(db, "videos"), where("videoId", "==", id));
      const snapById = await getDocs(qById);
      if(!snapById.empty){
        setStatus("This video has already been added (same video ID).", false);
        return;
      }

      // 2) Check by exact URL (to handle full-link duplicates)
      const qByUrl = query(collection(db, "videos"), where("videoUrl", "==", url));
      const snapByUrl = await getDocs(qByUrl);
      if(!snapByUrl.empty){
        setStatus("This video has already been added (same URL).", false);
        return;
      }

      // 3) Check by title (exact match)
      const qByTitle = query(collection(db, "videos"), where("videoTitle", "==", title));
      const snapByTitle = await getDocs(qByTitle);
      if(!snapByTitle.empty){
        setStatus("This video has already been added (same title).", false);
        return;
      }

      // If we reached here, no duplicate found — safe to add
      await addDoc(collection(db, "videos"), videoDoc);

      // Show preview & success
      thumbEl.src = thumb;
      videoTitleEl.textContent = title;
      previewEl.style.display = "block";
      setStatus("Video added successfully ✔", true);

      // clear input
      videoUrlEl.value = "";

    } catch (err) {
      console.error(err);
      setStatus("Failed to add video: " + (err.message || err), false);
    } finally {
      addBtn.disabled = false;
      addBtn.textContent = "Add Video";
    }
  });

  // ---------- Logout ----------
  btnLogout.addEventListener('click', async () => {
    try { await signOut(auth); } catch(_) {}
    sessionStorage.removeItem("jzd_session");
    location.replace("login.html");
  });

  // ---------- Small client hardening (non-breaking) ----------
  document.addEventListener('contextmenu', e => e.preventDefault());
</script>
<script>
// Disable Right Click
document.addEventListener('contextmenu', function(e) {
    e.preventDefault();
});

// Disable Key Shortcuts
document.addEventListener('keydown', function(e) {

    // Block F12
    if (e.keyCode == 123) {
        e.preventDefault();
    }

    // Block Ctrl+Shift+I / Ctrl+Shift+J / Ctrl+U
    if (e.ctrlKey && e.shiftKey && (e.keyCode == 73 || e.keyCode == 74)) {
        e.preventDefault();
    }

    if (e.ctrlKey && e.keyCode == 85) {
        e.preventDefault();
    }

    // Block Ctrl+S, Ctrl+C,
    if (e.ctrlKey && (e.keyCode == 83 || e.keyCode == 67)) {
        e.preventDefault();
    }
});
</script>


</body>
</html>
